#!/bin/sh
#
# install script:
# FORCE_DOWNLOAD_BIN=0; url=https://raw.githubusercontent.com/timqi/nq/main/thin-installer; if command -v curl 2>&1 >/dev/null; then curl -s --progress-bar -L $url | sh -s $FORCE_DOWNLOAD_BIN; elif command -v wget 2>&1 >/dev/null; then wget -O- $url | sh -s $FORCE_DOWNLOAD_BIN; fi; [ -d $HOME/nq ] && source $HOME/nq/profile
#
# $1: FORCE_DOWNLOAD_BIN
#
#
FORCE_DOWNLOAD_BIN=$1
echo "FORCE_DOWNLOAD_BIN: " $FORCE_DOWNLOAD_BIN

download_and_decompress() {
    echo "Download from $1"
    echo "Download to $2"
    if command -v curl 2>&1 >/dev/null; then
        curl -L -H "Cache-Control: no-cache" --progress-bar "$1" | tar -zx -C $2
    elif command -v wget 2>&1 >/dev/null; then
        wget $1 -O - | tar -zx -C $2
    fi
}

nq_dir="$HOME/nq"
if [ ! -d $nq_dir ] || [ "$FORCE_DOWNLOAD_BIN" = "1" ]; then
    nq_url="https://github.com/timqi/nq/releases/download/thin/nq.thin.tar.gz"
    [ -d $nq_dir ] && rm -rf $nq_dir
    mkdir -p $nq_dir
    download_and_decompress $nq_url $nq_dir
fi

# Download configs
nq_script_dir="$nq_dir/nq-main"
[ -d $nq_script_dir ] && rm -rf $nq_script_dir
url="https://github.com/timqi/nq/archive/main.tar.gz"
download_and_decompress $url $nq_dir

mv "$nq_script_dir/bin/"* "$nq_dir/bin/"
mv "$nq_script_dir/nq" "$nq_dir/bin/"
mv "$nq_script_dir/config/profile" $nq_dir/profile
if ! command zle &>/dev/null; then
    sed -i '/# zsh syntax begin/,/# zsh syntax end/g' "$nq_dir/profile"
fi
mv "$nq_script_dir/config/tmux.conf" $nq_dir/tmux.conf
ln -sv $nq_dir/tmux.conf $HOME/.tmux.conf

# Add vim executable
vim_dir="$nq_dir/vim"
mv "$nq_script_dir/config/vimrc" "$vim_dir"
ln -sv $vim_dir $HOME/.vim
cat <<EOF > "$nq_dir/bin/vim"
VIMRUNTIME="$vim_dir/runtime" "$vim_dir/vim" \$@
EOF
cat <<EOF > "$nq_dir/bin/suvim"
VIMRUNTIME="$vim_dir/runtime" sudo -E "$vim_dir/vim" \$@
EOF
chmod +x "$nq_dir/bin/vim" "$nq_dir/bin/suvim"

# Delete nq scripts
rm -rf $nq_script_dir

# Handle terminfo
if [ ! -d /etc/terminfo ]; then
   mv "$nq_dir/vim/terminfo" /etc
fi

# Add source profile
profile="$HOME/.profile"
source_cmd="source $nq_dir/profile"
if [ ! -f "$profile" ]; then
    echo "$source_cmd" > $profile
else
    sed -i "s|source $nq_dir/shprofile|$source_cmd|g" $profile
    if ! grep -q "$source_cmd" $profile; then
        echo "$source_cmd" >> $profile
    fi
fi

